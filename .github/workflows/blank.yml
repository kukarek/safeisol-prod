name: Deploy Django to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build and restart Docker container on server
        uses: appleboy/ssh-action@v0.1.6
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_PORT: ${{ secrets.DB_PORT }}
          CELERY_BROKER_URL: ${{ secrets.CELERY_BROKER_URL }}
          CELERY_RESULT_BACKEND: ${{ secrets.CELERY_RESULT_BACKEND }}
          ALLOWED_HOSTS: ${{ secrets.ALLOWED_HOSTS }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
          EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
          DEFAULT_FROM_EMAIL: ${{ secrets.DEFAULT_FROM_EMAIL }}
          SMTP: ${{ secrets.SMTP }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |

            # Создаем папку проекта и переходим в неё
            mkdir -p /var/www/safeisol
            cd /var/www/safeisol
            
            cat > .env <<EOF
            DB_HOST=$DB_HOST
            DB_NAME=$DB_NAME
            DB_USER=$DB_USER
            DB_PASSWORD=$DB_PASSWORD
            DB_PORT=$DB_PORT
            CELERY_BROKER_URL=$CELERY_BROKER_URL
            CELERY_RESULT_BACKEND=$CELERY_RESULT_BACKEND
            ALLOWED_HOSTS=$ALLOWED_HOSTS
            SECRET_KEY=$SECRET_KEY
            EMAIL_HOST_USER=$EMAIL_HOST_USER
            EMAIL_HOST_PASSWORD=$EMAIL_HOST_PASSWORD
            DEFAULT_FROM_EMAIL=$DEFAULT_FROM_EMAIL
            SMTP=$SMTP
            EOF


            # Клонируем репозиторий или обновляем его
            if [ -d ".git" ]; then
              echo "Обновляю существующий репозиторий"
              git fetch origin
              git reset --hard origin/main
            else
              echo "Клонирую репозиторий"
              git clone https://github.com/kukarek/safeisol-prod.git .
            fi

            # Устанавливаем PostgreSQL, если он не установлен
            if ! command -v psql > /dev/null; then
              echo "PostgreSQL не найден, устанавливаю..."
              sudo apt-get update
              sudo apt-get install -y postgresql postgresql-contrib
              sudo systemctl enable postgresql
              sudo systemctl start postgresql
            else
              echo "PostgreSQL уже установлен"
            fi

            # Проверяем, создана ли база данных, если нет - создаем
            if ! sudo -u postgres psql -lqt | cut -d \| -f 1 | grep -qw "$DB_NAME"; then
              echo "Создаю базу данных $DB_NAME и пользователя $DB_USER"
              sudo -u postgres psql -c "CREATE DATABASE \"$DB_NAME\";"
              sudo -u postgres psql -c "CREATE USER \"$DB_USER\" WITH PASSWORD '$DB_PASSWORD';"
              sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE \"$DB_NAME\" TO \"$DB_USER\";"
            else
              echo "База данных $DB_NAME уже существует"
            fi

            # Обновляем образы и запускаем контейнеры Docker
            docker-compose build
            docker-compose up -d --force-recreate

            docker-compose logs safeisol-prod-web-1

            # Выполняем миграции, сбор статики и загрузку данных внутри контейнера
            docker-compose exec web python manage.py migrate --noinput
            docker-compose exec web python manage.py loaddata data.json
