name: Deploy Django to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e  # Выход при любой ошибке

            # Папка проекта
            PROJECT_DIR=/var/www/safeisol
            mkdir -p $PROJECT_DIR
            cd $PROJECT_DIR

            # Создаем или обновляем .env
            cat > .env <<EOF
            DB_HOST=${{ secrets.DB_HOST }}
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_PORT=${{ secrets.DB_PORT }}
            CELERY_BROKER_URL=${{ secrets.CELERY_BROKER_URL }}
            CELERY_RESULT_BACKEND=${{ secrets.CELERY_RESULT_BACKEND }}
            ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
            EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
            DEFAULT_FROM_EMAIL=${{ secrets.DEFAULT_FROM_EMAIL }}
            SMTP=${{ secrets.SMTP }}
            ADMIN_PASS=${{ secrets.ADMIN_PASS }}
            EOF

            # Клонируем или обновляем репозиторий
            if [ -d ".git" ]; then
              git fetch origin
              git reset --hard origin/main
            else
              git clone https://github.com/kukarek/safeisol-prod.git .
            fi

            # Docker: сборка и запуск
            docker-compose pull
            docker-compose build --pull
            docker-compose up -d --force-recreate

            # Ждем, пока контейнер web будет готов
            max_attempts=20
            attempt=0
            until docker-compose exec web python manage.py check > /dev/null 2>&1 || [ $attempt -eq $max_attempts ]; do
              echo "Waiting for web container... ($attempt/$max_attempts)"
              attempt=$((attempt + 1))
              sleep 3
            done
            [ $attempt -eq $max_attempts ] && { echo "Web container failed to start"; exit 1; }

            # Миграции
            docker-compose exec web python manage.py migrate --noinput

            # Тесты с покрытием
            docker-compose exec web coverage run --source='.' manage.py test
            docker-compose exec web coverage report -m

            # Чистка старых образов Docker
            docker image prune -af

      - name: Check disk space
        run: |
          MIN_FREE_GB=1
          FREE_GB=$(df --output=avail -BG / | tail -1 | tr -dc '0-9')
          if [ "$FREE_GB" -lt "$MIN_FREE_GB" ]; then
            echo "❌ Недостаточно места: ${FREE_GB}G"
            exit 1
          fi
          echo "✅ Свободного места достаточно: ${FREE_GB}G"
